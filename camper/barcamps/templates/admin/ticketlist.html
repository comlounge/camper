{% set menu="tickets" %}
{% extends "admin_master.html" %}


{% macro userlist(tickets, tc_id, typ="participants") %}
    <ul class="admin-participants">
    {% for ticket in tickets %}
        <li class="participant">
            <a class="participant-avatar" href="{{url_for('profile', username = ticket.user.username)}}" data-toggle="tooltip" title="{{ticket.user.fullname}}">
                <img class="profile-image-userlist" src="{{userview(ticket.user).image_thumb}}">
            </a>
            <a class="participant-name" href="{{url_for('profile', username = ticket.user.username)}}" title="{{ticket.user.fullname}}">
                {{ticket.user.fullname}}
            </a>
            
            {% if typ!="canceled" %}
            <div class="btn-group actions">
                <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-gear"></i>
                </button>
                <ul class="dropdown-menu" role="menu">
                    {% if typ=="pending" %}
                        <li><a href="#" 
                            data-status="approve" 
                            data-tcid="{{tc_id}}" 
                            data-tid="{{ticket._id}}" 
                            data-uid="{{ticket.user._id}}" 
                            class="listaction"><i class="fa fa-arrow-right"></i> {{_('Approve ticket')}}</a></li>
                        <li><a href="#" 
                            data-status="cancel" 
                            data-tcid="{{ticket._id}}" 
                            data-tid="{{ticket._id}}" 
                            data-uid="{{ticket.user._id}}" class="listaction"><i class="fa fa-arrow-left"></i> {{_('Cancel Ticket')}}</a></li>
                    {% elif typ=="confirmed" %}
                        <li><a href="#" 
                            data-status="cancel" 
                            data-tid="{{ticket._id}}" 
                            data-tcid="{{tc_id}}" 
                            data-uid="{{ticket.user._id}}" class="listaction"><i class="fa fa-arrow-left"></i> {{_('Cancel Ticket')}}</a></li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
{% endmacro %}

{% block content %}
    <div class="page-header">
        <h1>{{_('Manage ticket reservations')}}</h1>
    </div>
    {% for tc in ticket_classes %}
        <section class="panel panel-info ticket-user-list">
            <div class="panel-heading">
                <h2 class="panel-title">{{tc.name}}</h2>
            </div>

            {% if tc.pending %}
                <div class="panel-body">
                    <h4>{{'Pending Ticket Reservations'}}</h4>
                    {{userlist(tc.pending, tc._id, typ="pending")}}
                </div>
            {% endif %}

            {% if tc.confirmed %}
                <div class="panel-body">

                    <h4>{{'Confirmed Ticket Reservations'}}</h4>
                    {{userlist(tc.confirmed, tc._id, typ="confirmed")}}
                </div>
            {% endif %}

            {% if tc.canceled %}
                <div class="panel-body">

                    <h5>{{'Canceled Ticket Reservations'}}</h5>
                    {{userlist(tc.canceled, tc._id, typ="canceled")}}
                </div>
            {% endif %}



        </section>
            
    {% endfor %}
{% endblock %}


{% block bcjs %}
<script type="text/javascript">
$(document).ready( function () {
    $(".listaction").click( function () {
        var uid = $(this).data("uid");
        var status = $(this).data("status");
        var tc_id = $(this).data("tcid");
        var tid = $(this).data("tid");
        var url = document.location.href;
        
        $.ajax({
            url: url,
            type: "POST",
            data: {
                status: status,
                tc_id: tc_id,
                tid: tid,
                uid: uid
            },
            success: function(data) {
                if (data.reload) {
                    window.location.reload();
                }
            }
        })
    })

})
</script>
{% endblock %}
